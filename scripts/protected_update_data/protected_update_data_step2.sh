#!/bin/bash
source config.sh

#### Configurable Variables Start

## Target OID for data protected update, manifest and final fragment
# Target OID
TARGET_OID=e0e1
# Sample Manifest and Fragment for int-E0E8, Conf-F1D4, Ver=03, Target OID = E0E1 used for data protected update 
MANIFEST="8443A10126A10442E0E8589D8601F6F6842019032E03820001828220582582182958201DB201065AE8397B176645D7A87FBCE605707F2255E010B4188E149A862D5CB782018343A1010A81825854A30442F1D4013A000100B7058244746573745840CC86AA2BAEA5E7132809A989DF5DDB89B97A23B886A87D7AA9362EBF465F88F31433E5959E138738F92D84BB88D28F7C3292A6EA76000A2C3219421E040CE010F6F6824042E0E15840746DB5F55C432319D6AF13164B7D31E7925DA3AC433D6C6FDEEEF44E160729BF63C9467B4E4ECB197235E8C1B082333D52C0206CC2B697C8A971C7E87C002EF3"
CONTINUE_FRAGMENT="636BDDC11F3002E10B9526983603040D836BE04CD45910BB0EF3AACF2635EC7D6C0B8B3A5457836AC3792B463683E2FA2CD5AE3258EA3C427CF977D3DE9F7F5B3CB9FD9861DE2270AF48070F8E0A1B6477FB00E60BC67F824A86D402782245FE7B0D6012815EF8996093704397F5C0E480847046AF6FA5456377640AC0C320636653CF9BB5179AA7F3CB1F443A6E04DD429D335E9B36F873D86A67B123F9B445F0FC11074038ABAE23A8F8668B70331BF16EB4CBE8185AB7A6B2A4EC717707F4A169CB47A3349A9F26C0E7D86D2072A2C061EE33A2303961C8A5AAB07A8B85586D9DA2673FC8670F0125551EB1595110B17990EAF3D6368BA661FBBCB70DAA0D30438F9EFF0CADEF92C9F96CFB52541E1244EBC060705BFDBE897FF9300B798C72BD932569018AF27509286A3EFE05E3F3FEE45198C2BB707071C72BB937F7A6C6553AC908BE3A575D892A81C080B7FA0AEA30B4B53E1926A284D5EB866FBB9F1322DD8F5868BE9EF7AB5C06BAC2B30AD0185CF0C1C46763443360F482AD9344220A10FA24EFFB31906932B7A3C978314EA973B09EAEC93DC96A365AD31CFEA2EAE888E04654CA0B19379571C6E9037946439BC94C590A04E3AC25D68ABF9AE834E7127E6977D63134FD11B3FC8C8309402B7B122A78AF9E49225B640E51E108704E3E0E8F5CA8E32A5C388BC692CFE73581816869CD7A29E9C31FA52802FE1110CD993217A8808B589A77D9D21729A847264F7C8FE9687484C2495557D72842F6B4D5BED063F23E5B30B5617E040108D6AC2A049E123D99D16DC61CC6C7E3629A1E55528B5182848BCA69FD7E986AF001C07E06F56C95C11C2B66771FFF5F09ADD125573B4B57E310FEDA9B4650008F1D818121F526577A24D2C9D0523C388C"
FINAL_FRAGMENT="C113BDF2C628E1615521033C6B3D3926FADDBD95474D9837B95B6A4DC48B1E60843CCBEED526C120BC763996CE24CC9C81202A4F3A49BDF5D377E621B5AC634EE619706C925071E3FE028BCD1CC6F2DA1B899A7E6F73219E282CE5E61A21E400F23E0F4B11C4D1950624F00DE31527A0B6B172140B98CEBC244B6DB72C0CA19930FD8F70774DFB82E29FACF86CB720232EBB075ADDDC9A8ADB48B8BE3BC338C5682C6D8F51A3E6232FCC8610FD856AD8695FF4D2648BD2726CF7C77E90B5FF244835BD826F68206F601C9FD80F9A2EB71611E48246021A9264D6EB305A6A"


#### Configurable Variables End

# Perform multiple sequential read
echo "Prepare binary shared secret."
echo $MANIFEST | xxd -r -p > manifest_data.dat
#~ xxd manifest.dat
echo "Prepare binary data to be init."
echo $CONTINUE_FRAGMENT | xxd -r -p > continue_fragment.dat
#~ xxd continue_fragment.dat
echo "Prepare binary data to be init."
echo $FINAL_FRAGMENT | xxd -r -p > final_fragment.dat
#~ xxd final_fragment.dat

for i in $(seq 1 1); do
echo "test $i"

echo "Data protected update for 0x$TARGET_OID"
$EXEPATH/trustm_protected_update_data -k 0x$TARGET_OID -m manifest_data.dat -c continue_fragment.dat -f final_fragment.dat
echo "read out metadata for 0x$TARGET_OID"
$EXEPATH/trustm_metadata -r  0x$TARGET_OID -X



sleep 1
done
