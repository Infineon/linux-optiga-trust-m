#!/bin/bash
source config.sh

#### Configurable Variables Start

## Target OID for data protected update, manifest and fragment
# Target OID
TARGET_OID=e0e1
# Sample Manifest and Fragment for int-E0E8, Conf-F1D4, Ver=01, Target OID = E0E1 used for data protected update 
MANIFEST="8443A10126A10442E0E8589D8601F6F684201901300182000282822058258218295820CA9936B8B4FDC2992024CE2F70D7352C572E0522C6D5EDDEAC387CD5BC6948F582018343A1010A81825854A30442F1D4013A000100B70582447465737458401FCB64EDC85A80A299CF0F1D06E322C34D35A2F6A819A58227CAB93EBC46BC8BB6B23358659F5C6C858CFDA8A261B18529AEE37157D674E29FBC0905A281FBFFF6F6824042E0E1584031DC3E5A1DE5736465C56810ED27F9F89B230ACF1E8F038386B9F249B7F23CB176E41FB4ED41564EAE783BCA35FE492123110AEBD856389A6D92A1EB01E17525"
FINAL_FRAGMENT="57E0FE55A7708B87F944EF67E49E9B09AAAFDA2C1270EB4DF78D113775C604620746AB743F3A04C39E3B5644554D49F0A16AD09B97B4B47EEAF89C0E34B932DB6B28921F7A0A620B8FD70AEBA1172E13A9428A3052E0B95BF5333D1C31C7F11E035D67774F0F65E9446268D167CB747E36F89D4341B4AF8EE8517B603B146AB7F6648E24737020DDA9361BCDDA259A7BC049ACB06A0627ED446F8C9ED82572E7DA181CF401A0652ADA4137036D07EECD254CAAB7946C66B3D6D02EB49E1F1A6DAFD4B16858E76DB6A3B4260DB975D62A520D41114A60E4B18915DEA7367A0675DF2DF24DE2603E6DC1DF3BCCEB8FB96CC4631567975498741B210E56E8A3A8E2E55A622FD58111216C782B8074891612C232D9565D65D2FD3F36A4F2C6D1ECF9B2A9B6FD3127C4E1C91D45AE027F1E81700874E681D884F5"

#### Configurable Variables End

# Perform multiple sequential read
echo "Prepare manifest.dat."
echo $MANIFEST | xxd -r -p > manifest.dat
xxd manifest.dat
echo "Prepare fragment"
echo $FINAL_FRAGMENT | xxd -r -p > fragment_0.dat
xxd fragment_0.dat

for i in $(seq 1 1); do
echo "test $i"

echo "Data protected update for 0x$TARGET_OID"
$EXEPATH/trustm_protected_update_data -k 0x$TARGET_OID -m manifest.dat -f fragment_0.dat 
echo "read out metadata for 0x$TARGET_OID"
$EXEPATH/trustm_metadata -r  0x$TARGET_OID -X



sleep 1
done
